# Development Session - 2025-08-13 13:55

## Session Overview
- **Start Time**: 2025-08-13 13:55 UTC
- **Project**: Personal Website & Blog (Nuxt 4 + Vue 3)
- **Branch**: source

## Goals
Fix CI failure in blog metadata generation caused by draft-only changes triggering unnecessary processing

## Progress
### ✅ Root Cause Analysis
- **Issue**: CI detected blog changes but failed metadata generation
- **Cause**: Modified draft post (`blog/drafts/_priority/recent-ai-reading/readme.md`) with `published: false`
- **Problem**: CI change detection didn't distinguish between draft and published content

### ✅ Investigation Results
- Draft posts are correctly excluded from metadata processing via `ignore=shutil.ignore_patterns('*.gitkeep', 'drafts')`
- CI generated empty metadata `[]` when no publishable posts changed
- Metadata generation itself worked correctly - issue was in change detection logic

### ✅ Long-term Fix Implementation
**Updated `.github/workflows/main.yml`:**
1. **Enhanced Change Detection**: 
   - Filter out posts in `/drafts/` folders
   - Check frontmatter for `published: false` 
   - Only trigger processing for publishable content changes
   
2. **Improved Logging**:
   - Clear distinction between draft and published changes
   - Informative messages when skipping draft-only changes
   
3. **Optimized Processing Mode**:
   - Added `use-cached` mode handling for no publishable changes
   - Prevents unnecessary metadata regeneration

### ✅ Testing
- Verified logic correctly identifies draft-only vs published changes
- Confirmed workflow will skip metadata processing for draft-only commits

### ✅ Cache Invalidation Fix  
**Problem Identified**: Blog content hash included ALL files (118 total) but processing excluded drafts (28 files), causing cache mismatches.

**Fixed `.github/workflows/main.yml`:**
1. **Updated 3 hash calculations** to exclude drafts: `! -path "*/drafts/*"`
   - Line 56: Initial blog hash calculation  
   - Line 165: Topic cache validation hash
   - Line 543: Build cache hash calculation
   
2. **Bumped cache version** from `v3` to `v4` to invalidate old caches

3. **Verified fix**:
   - OLD hash (118 files): `0bce6457676a28eac28f94e9e338e196d91d2591d82f4f642ab5f0cc841b2d94`
   - NEW hash (90 files): `9dea7a9d97a06ab20f4db2f35248f7ab68c73f428ec6a04a835d8bec8f55593a`
   - Hash values completely different, confirming proper cache invalidation

### ✅ Nuxt Generate 500 Errors Fix
**Problem**: CI failures during `nuxt generate` with 500 errors on `/blog/tags`, `/blog/author/undefined/`, `/blog/category/undefined/`, `/blog/tag/undefined/`

**Root Cause**: Array access without null checks in blog routing logic:
- `BlogMetadata.ts getTags()` line 290: `tagName[0].name`
- `BlogMetadata.ts getCategories()` line 266: `catName[0].name` 
- `blog/author/[name].vue authorName()` line 66: `authName[0].name`
- Similar issues in category and tag pages

**Fixed Files**:
1. **`app/stores/BlogMetadata.ts`**:
   - Added null checks before accessing `tagName[0].name` and `catName[0].name`
   - Skip items with empty/invalid names to prevent undefined routes

2. **`app/pages/blog/author/[name].vue`**:
   - Added comprehensive null checks in `authorName()` function
   - Return "Unknown Author" for invalid/missing data

3. **`app/pages/blog/category/[name].vue`**:
   - Added null checks in `categoryName()` function  
   - Return "Unknown Category" for invalid/missing data

4. **`app/pages/blog/tag/[name].vue`**:
   - Added null checks in `tagName()` function
   - Return "Unknown Tag" for invalid/missing data

**Expected Result**: Static generation will complete successfully without 500 errors

### ✅ Metadata Regeneration & Additional Fixes 
**Problem**: After cache fix, metadata was stale and missing recent 2025 posts. Also found undefined route generation.

**Root Causes**:
1. **Metadata Script Path Issue**: Script needed to run from project root, not website directory
2. **Undefined Route Generation**: Components generating `/blog/author/undefined/`, `/blog/category/undefined/`, `/blog/tag/undefined/` due to missing slug validation

**Fixed**:
1. **Regenerated Metadata**: Ran `scripts/update-blog-metadata.sh --force` from project root
   - ✅ Now includes all 89 posts including target `recent-ai-reading-11-august-2025`
   - ✅ All blog posts properly processed with topic extraction

2. **Added Null Checks to Blog Post Page** (`app/pages/blog/[year]/[month]/[day]/[post].vue`):
   - Added `postMetadata` validation with 404 error handling
   - Added safe processing for `categories`, `tags`, and `authors` arrays
   - Prevents runtime errors from missing or malformed metadata

3. **Fixed Undefined Route Generation** in 3 components:
   - `app/components/blog/bookmark-post-card.vue`
   - `app/components/blog/posts-list/post-header.vue`  
   - `app/components/blog/single-post/post-header.vue`
   - Added validation to `getAuthorRoute()`, `getCategoryRoute()`, `getTagRoute()` methods
   - Return `#` fallback for undefined/invalid slugs instead of generating bad routes

**Expected Results**: 
- ✅ Blog post pages load without 500 errors
- ✅ No more `/undefined/` routes generated  
- ✅ Graceful handling of missing/invalid metadata
- ✅ Static generation completes successfully

---