import{p as w}from"./Iz-BM7we.js";class p{constructor(){this.searchIndex=null,this.embeddingPipeline=null,this.isInitialized=!1}async initialize(){if(!this.isInitialized){if(typeof window>"u"){console.warn("Search service can only be initialized on the client side");return}try{const e=await fetch("/search_index.json");this.searchIndex=await e.json(),this.embeddingPipeline=await w("feature-extraction","Xenova/all-MiniLM-L6-v2"),this.isInitialized=!0,console.log(`Search service initialized with ${this.searchIndex.length} entries`)}catch(e){throw console.error("Failed to initialize search service:",e),e}}}async generateQueryEmbedding(e){if(!this.embeddingPipeline)throw new Error("Search service not initialized");const a=await this.embeddingPipeline(e,{pooling:"mean",normalize:!0});return Array.from(a.data)}cosineSimilarity(e,a){if(e.length!==a.length)throw new Error("Vectors must have the same length");let r=0,o=0,i=0;for(let d=0;d<e.length;d++)r+=e[d]*a[d],o+=e[d]*e[d],i+=a[d]*a[d];return o=Math.sqrt(o),i=Math.sqrt(i),o===0||i===0?0:r/(o*i)}keywordSearch(e,a){const o=e.toLowerCase().split(/\s+/).filter(i=>i.length>2);return a.map(i=>{const d=i.title.toLowerCase(),g=i.content.toLowerCase(),c=i.categories.join(" ").toLowerCase(),n=i.tags.join(" ").toLowerCase();let t=0;return o.forEach(s=>{d.includes(s)&&(t+=3),g.includes(s)&&(t+=1),c.includes(s)&&(t+=2),n.includes(s)&&(t+=2)}),{...i,score:t}}).filter(i=>i.score>0)}async search(e,a={}){this.isInitialized||await this.initialize();const{limit:r=10,threshold:o=.1,useSemanticSearch:i=!0,categories:d=[],tags:g=[]}=a;try{let c=[];if(i&&e.length>3){const n=await this.generateQueryEmbedding(e);c=this.searchIndex.map(t=>{const s=this.cosineSimilarity(n,t.embedding);return{...t,score:s}}).filter(t=>t.score>o)}else c=this.keywordSearch(e,this.searchIndex);return d.length>0&&(c=c.filter(n=>n.categories.some(t=>d.includes(t)))),g.length>0&&(c=c.filter(n=>n.tags.some(t=>g.includes(t)))),c.sort((n,t)=>t.score-n.score),c=c.slice(0,r),{query:e,results:c,totalResults:c.length,searchType:i?"semantic":"keyword"}}catch(c){if(console.error("Search error:",c),i)return this.search(e,{...a,useSemanticSearch:!1});throw c}}getSuggestions(){if(!this.searchIndex||typeof window>"u")return{categories:[],tags:[]};const e=new Set,a=new Set;return this.searchIndex.forEach(r=>{r.categories.forEach(o=>e.add(o)),r.tags.forEach(o=>a.add(o))}),{categories:Array.from(e).sort(),tags:Array.from(a).sort()}}getFilterCounts(){if(!this.searchIndex||typeof window>"u")return{categories:{},tags:{},postFormats:{}};const e={},a={},r={};return this.searchIndex.forEach(o=>{if(o.categories?.forEach(i=>{e[i]=(e[i]||0)+1}),o.tags?.forEach(i=>{a[i]=(a[i]||0)+1}),o["post-format"]?.name){const i=o["post-format"].name;r[i]=(r[i]||0)+1}}),{categories:e,tags:a,postFormats:r}}previewSearchCount(e,a={}){if(!this.searchIndex||typeof window>"u")return 0;let r=this.searchIndex;if(a.categories&&a.categories.length>0&&(r=r.filter(o=>o.categories.some(i=>a.categories.includes(i)))),a.tags&&a.tags.length>0&&(r=r.filter(o=>o.tags.some(i=>a.tags.includes(i)))),a.postFormat&&(r=r.filter(o=>o["post-format"]?.name===a.postFormat)),(a.dateStart||a.dateEnd)&&(r=r.filter(o=>{const i=new Date(o.date),d=a.dateStart?new Date(a.dateStart):null,g=a.dateEnd?new Date(a.dateEnd):null;return!(d&&i<d||g&&i>g)})),e&&e.trim().length>0){const o=e.toLowerCase();r=r.filter(i=>{const d=i.title.toLowerCase(),g=i.content.toLowerCase(),c=i.categories.join(" ").toLowerCase(),n=i.tags.join(" ").toLowerCase();return d.includes(o)||g.includes(o)||c.includes(o)||n.includes(o)})}return r.length}getViableFilterCombinations(e={}){if(!this.searchIndex||typeof window>"u")return{categories:{},tags:{},postFormats:{}};this.searchIndex;const a=n=>{let t=this.searchIndex;return n!=="categories"&&e.categories&&e.categories.length>0&&(t=t.filter(s=>s.categories.some(l=>e.categories.includes(l)))),n!=="tags"&&e.tags&&e.tags.length>0&&(t=t.filter(s=>s.tags.some(l=>e.tags.includes(l)))),n!=="postFormat"&&e.postFormat&&(t=t.filter(s=>s["post-format"]?.name===e.postFormat)),n!=="date"&&(e.dateStart||e.dateEnd)&&(t=t.filter(s=>{const l=new Date(s.date),h=e.dateStart?new Date(e.dateStart):null,f=e.dateEnd?new Date(e.dateEnd):null;return!(h&&l<h||f&&l>f)})),t},r={};a("categories").forEach(n=>{n.categories?.forEach(t=>{r[t]=(r[t]||0)+1})});const i={};a("tags").forEach(n=>{n.tags?.forEach(t=>{i[t]=(i[t]||0)+1})});const g={};return a("postFormat").forEach(n=>{if(n["post-format"]?.name){const t=n["post-format"].name;g[t]=(g[t]||0)+1}}),{categories:r,tags:i,postFormats:g}}getRecentPosts(e=5){return!this.searchIndex||typeof window>"u"?[]:this.searchIndex.sort((a,r)=>new Date(r.date)-new Date(a.date)).slice(0,e).map(a=>({id:a.id,title:a.title,url:a.url,date:a.date,categories:a.categories,tags:a.tags}))}async findRelatedPosts(e,a={}){this.isInitialized||await this.initialize();const{limit:r=5,threshold:o=.15,excludeCurrentPost:i=!0,preferSameCategory:d=!0,preferSameTags:g=!0}=a;if(!this.searchIndex||typeof window>"u")return[];try{let c=this.searchIndex;i&&e.id&&(c=c.filter(s=>s.id!==e.id));const n=`${e.title} ${e.categories?.join(" ")||""} ${e.tags?.join(" ")||""}`;let t=[];if(n.length>3&&this.embeddingPipeline){const s=await this.generateQueryEmbedding(n);t=c.map(l=>{const h=this.cosineSimilarity(s,l.embedding);let f=h;if(d&&e.categories){const m=l.categories?.filter(u=>e.categories.includes(u)).length||0;f+=m*.1}if(g&&e.tags){const m=l.tags?.filter(u=>e.tags.includes(u)).length||0;f+=m*.05}return{...l,score:f,semanticSimilarity:h}}).filter(l=>l.score>o)}else t=c.map(s=>{let l=0;if(e.categories&&s.categories){const h=s.categories.filter(f=>e.categories.includes(f)).length;l+=h*.3}if(e.tags&&s.tags){const h=s.tags.filter(f=>e.tags.includes(f)).length;l+=h*.2}return{...s,score:l}}).filter(s=>s.score>0);return t.sort((s,l)=>l.score-s.score),t=t.slice(0,r),t.map(s=>({id:s.id,title:s.title,url:s.url,date:s.date,categories:s.categories,tags:s.tags,score:s.score,semanticSimilarity:s.semanticSimilarity}))}catch(c){return console.error("Error finding related posts:",c),this.searchIndex.filter(t=>{if(i&&e.id&&t.id===e.id)return!1;const s=e.categories?.some(h=>t.categories?.includes(h)),l=e.tags?.some(h=>t.tags?.includes(h));return s||l}).slice(0,r).map(t=>({id:t.id,title:t.title,url:t.url,date:t.date,categories:t.categories,tags:t.tags,score:.1}))}}}const E=new p;export{E as default,E as searchService};
